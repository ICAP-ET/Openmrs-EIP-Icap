<routes xmlns="http://camel.apache.org/schema/spring">

    <route id="out-bound-db-sync" errorHandlerRef="recordingErrorHandler">
        <from uri="direct:out-bound-db-sync" />

        <log message="Processing debezium event: ${body}" loggingLevel="DEBUG" />

        <choice>
            <when>
                <simple>${headers.CamelDebeziumOperation} == 'd'</simple>
                <setBody>
                    <simple>DELETE:${exchangeProperty.debezium-table}:${exchangeProperty.entity-id}</simple>
                </setBody>

                <log message="Deleted entity payload -> ${body}" />
            </when>
            <otherwise>
                <log message="Loading entity from DB..." loggingLevel="DEBUG" />

                <toD uri="openmrs:extract?tableToSync=${exchangeProperty.debezium-table.toUpperCase()}&amp;uuid=${exchangeProperty.entity-id}" />

                <log message="Loaded entity -> ${body}" />

                <choice>
                    <when>
                        <simple>${body} != '[]'</simple>
                        <setBody>
                            <jsonpath>$[0]</jsonpath>
                        </setBody>
                        <marshal>
                            <json library="Jackson" />
                        </marshal>
                    </when>
                    <otherwise>
                        <setBody>
                            <simple>${null}</simple>
                        </setBody>
                    </otherwise>
                </choice>
            </otherwise>
        </choice>

        <choice>
            <when>
                <simple>${body} != null</simple>
                <log message="Pushing entity to sync queue: {{camel.output.endpoint}}" loggingLevel="DEBUG" />

                <toD uri="{{camel.output.endpoint}}" />
            </when>
            <otherwise>
                <!-- TODO Log to a special failures log file or DB -->
                <log message="No entity found in the database matching identifier: ${exchangeProperty.entity-id}" loggingLevel="ERROR" />
            </otherwise>
        </choice>

    </route>

</routes>
