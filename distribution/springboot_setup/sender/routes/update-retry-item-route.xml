<routes xmlns="http://camel.apache.org/schema/spring">

    <route id="update-retry-item">
        <from uri="direct:update-retry-item" />
        <log message="Handing failure for retry item..." loggingLevel="DEBUG" />

        <!-- TODO track ids of entities for events so that we don't process future failed events for the same entity -->
        <when>
            <simple>${exchangeProperty.retry-item} == null</simple>
            <log message="Loading event retry item with id: ${exchangeProperty.retry-item-id}" loggingLevel="DEBUG" />

            <toD uri="jpa:RetryQueueItem?query=SELECT r FROM RetryQueueItem r WHERE r.id = ${exchangeProperty.retry-item-id}" />

            <log message="Loaded: ${body}" loggingLevel="DEBUG" />
            <setProperty name="retry-item">
                <simple>${body[0]}</simple>
            </setProperty>
        </when>

        <script>
            <spel>
                #{getProperty('retry-item').setAttemptCount(getProperty('retry-item').getAttemptCount() + 1)}
                #{getProperty('retry-item').setMessage(getProperty('error-msg'))}
                #{getProperty('retry-item').setCauseMessage(getProperty('cause-error-msg'))}
                #{getProperty('retry-item').setDateChanged(new java.util.Date())}
            </spel>
        </script>
        <setBody>
            <simple>${exchangeProperty.retry-item}</simple>
        </setBody>

        <log message="Saving updates for retry queue item -> ${body}" loggingLevel="DEBUG" />

        <to uri="jpa:RetryQueueItem" />

        <log message="Successfully updated retry queue item ${body}" loggingLevel="DEBUG" />
    </route>
    
</routes>