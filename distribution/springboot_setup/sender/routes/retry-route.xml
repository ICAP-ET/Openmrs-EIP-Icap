<routes xmlns="http://camel.apache.org/schema/spring">

    <route id="out-bound-retry" errorHandlerRef="retryErrorHandler">
        <from uri="scheduler:retry?initialDelay={{db-event.retry.initial.delay}}&amp;delay={{db-event.retry.interval}}" />

        <log message="Fetching events in the retry queue" />

        <toD uri="jpa:RetryQueueItem?query=SELECT r.id FROM RetryQueueItem r" />

        <log message="Event count in the retry queue ${body.size()}" />

        <split>
            <simple>${body}</simple>
            <setProperty name="retry-item-id">
                <simple>${body}</simple>
            </setProperty>
            <log message="Loading event retry item with id: ${body}" />

            <toD uri="jpa:RetryQueueItem?query=SELECT r FROM RetryQueueItem r WHERE r.id = ${body}" />

            <setBody>
                <simple>${body[0]}</simple>
            </setBody>

            <log message="Retry processing: ${body}" />

            <setProperty name="event">
                <simple>${body.event}</simple>
            </setProperty>

            <setProperty name="db-event-destinations">
                <simple>${body.route}</simple>
            </setProperty>

            <to uri="direct:db-event-processor" />

            <!--<toD uri="jpa:RetryQueueItem?query=DELETE FROM RetryQueueItem WHERE id = ${body.id}" />-->
        </split>
    </route>

</routes>