<routes xmlns="http://camel.apache.org/schema/spring">
    <route id="db-event-listener" errorHandlerRef="outBoundErrorHandler">
        <from uri="direct:db-event-listener" />

        <log message="Received DB event: ${exchangeProperty.event}" />

        <setProperty name="retry-count">
            <simple>0</simple>
        </setProperty>

        <when>
            <simple>${exchangeProperty.event.operation} != 'c'</simple>
            <toD uri="jpa:SenderRetryQueueItem?query=SELECT r from SenderRetryQueueItem r WHERE r.event.tableName='${exchangeProperty.event.tableName}' AND r.event.primaryKeyId='${exchangeProperty.event.primaryKeyId}'" />
            <setProperty name="retry-count">
                <simple>${body.size()}</simple>
            </setProperty>
        </when>

        <setBody>
            <simple>${exchangeProperty.event}</simple>
        </setBody>

        <to uri="direct:db-event-processor" />

    </route>
</routes>
