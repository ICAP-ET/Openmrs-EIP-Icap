<routes xmlns="http://camel.apache.org/schema/spring">
  <route id="schedule">
    <from uri="scheduler:sync?delay=1m"/>
      <toD uri="jpa://org.openmrs.sync.app.management.entity.OpenmrsDatabase?query=SELECT d FROM org.openmrs.sync.app.management.entity.OpenmrsDatabase d" />
      <setProperty propertyName="openmrs-dbs">
          <simple>${body}</simple>
      </setProperty>
      <split streaming="true">
          <simple>${body}</simple>
          <setProperty propertyName="source-db">
              <simple>${body}</simple>
          </setProperty>
          <script>
              <spel>
                  #{T(org.openmrs.sync.app.config.DataSourceNameHolder).set(body.name)}
              </spel>
          </script>
          <doTry>
              <!-- TODO process in configured batch sizes -->
              <toD uri="sql:SELECT * from dbsync_sync_record WHERE status = 'NEW' or status = 'PROCESSING' ORDER BY date_created?dataSource=openmrsDataSource&amp;outputType=SelectList&amp;outputClass=org.openmrs.sync.component.entity.SyncRecord" />

              <split streaming="true">
                <simple>${body}</simple>
                <to uri="direct:process-sync-record" />
              </split>
              <doCatch>
                  <exception>java.lang.Exception</exception>
                  <log loggingLevel="ERROR" message="${exception.printStackTrace()}" />
              </doCatch>
              <doFinally>
                  <script>
                      <spel>
                          #{T(org.openmrs.sync.app.config.DataSourceNameHolder).clear()}
                      </spel>
                  </script>
              </doFinally>
          </doTry>
      </split>
  </route>
</routes>
