<routes xmlns="http://camel.apache.org/schema/spring">

    <route id="publish-sync-record-route" errorHandlerRef="deadLetterChannelBuilder">
        <from uri="direct:publish-sync-record-route" />

        <log message=":" />

        <log message="Publishing sync record: ${body}" />

        <setProperty propertyName="sync-record">
            <simple>${body}</simple>
        </setProperty>

        <log message="Configured destinations -> {{sync-record.destinations.dir}}" />

        <split>
            <simple>{{sync-record.destinations.dir}}</simple>
            <setProperty propertyName="sync-record-destination">
                <simple>body</simple>
            </setProperty>

            <log message="Publishing to destination: ${property.sync-record-destination}" />
            
            <setBody>
                <simple>${property.sync-record}</simple>
            </setBody>
            <marshal>
                <json library="Jackson" />
            </marshal>
            <setBody>
                <simple>body</simple>
            </setBody>
            
            <!--<process ref="pgpEncryptService"/>-->
            <toD uri="{{camel.output.endpoint}}/${property.sync-record-destination}" />
        </split>

        <setBody>
            <simple>${property.sync-record}</simple>
        </setBody>

        <log message="Archiving the sync record" />

        <toD uri="sql:INSERT INTO dbsync_sync_record_archive(entity_id, entity_table_name, operation, date_created, uuid, archive_date) SELECT entity_id, entity_table_name, operation, date_created, uuid, now() FROM dbsync_sync_record WHERE uuid = '${body.uuid}'?dataSource=openmrsDataSource" />

        <log message="Deleting the sync record" />

        <toD uri="sql:DELETE FROM dbsync_sync_record WHERE uuid = '${body.uuid}'?dataSource=openmrsDataSource" />

    </route>

</routes>
