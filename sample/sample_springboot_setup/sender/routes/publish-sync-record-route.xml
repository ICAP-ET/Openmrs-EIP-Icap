<routes xmlns="http://camel.apache.org/schema/spring">

    <route id="publish-sync-record-route" errorHandlerRef="deadLetterChannelBuilder">
        <from uri="direct:publish-sync-record-route" />

        <log message=":" />

        <log message="Publishing sync record: ${body}" />

        <setProperty name="sync-record">
            <simple>${body}</simple>
        </setProperty>

        <log message="Configured destinations -> {{sync-record.destinations}}" />

        <split stopOnException="true">
            <simple>{{sync-record.destinations}}</simple>
            <setProperty name="sync-record-destination">
                <simple>${body}</simple>
            </setProperty>

            <log message="Publishing to destination: ${exchangeProperty.sync-record-destination}" />
            
            <setBody>
                <simple>${exchangeProperty.sync-record}</simple>
            </setBody>
            <marshal>
                <json library="Jackson" />
            </marshal>
            <setBody>
                <simple>${body}</simple>
            </setBody>

            <!--<process ref="pgpEncryptService"/>-->
            <toD uri="activemq:${exchangeProperty.sync-record-destination}" />
        </split>

        <setBody>
            <simple>${exchangeProperty.sync-record}</simple>
        </setBody>

        <log message="Archiving the sync record" />

        <toD uri="sql:INSERT INTO dbsync_sync_record_archive(entity_id, entity_table_name, operation, date_created, uuid, archive_date) SELECT entity_id, entity_table_name, operation, date_created, uuid, now() FROM dbsync_sync_record WHERE uuid = '${body.uuid}'?dataSource=openmrsDataSource" />

        <log message="Deleting the sync record" />

        <toD uri="sql:DELETE FROM dbsync_sync_record WHERE uuid = '${body.uuid}'?dataSource=openmrsDataSource" />

    </route>

</routes>
