<routes xmlns="http://camel.apache.org/schema/spring">

    <route id="process-sync-record" errorHandlerRef="deadLetterChannelBuilder">
        <from uri="direct:process-sync-record" />

        <log message=":" />

        <log message="Processing sync record: ${body}" />

        <setProperty propertyName="sync-record">
            <simple>${body}</simple>
        </setProperty>

        <choice>
            <when>
                <simple>${body.operation} == 'DELETE'</simple>
                <setBody>
                    <simple>DELETE:${body.entityTableName}:${body.entityId}</simple>
                </setBody>
            </when>
            <otherwise>
                <log message="Loading entity from DB..." />

                <toD uri="openmrs:extract?tableToSync=${body.entityTableName}&amp;uuid=${body.entityId}" />

                <!-- TODO cater for scenario where entity could have been deleted just before this run,
                    one option is to skip this record with hope that there is a delete sync record in the queue -->

                <setBody>
                    <jsonpath>$[0]</jsonpath>
                </setBody>
                <marshal>
                    <json library="Jackson"/>
                </marshal>
            </otherwise>
        </choice>

        <log message="Loaded entity to be written to destinations -> ${body}" />

        <setProperty propertyName="entity-payload">
            <simple>body</simple>
        </setProperty>

        <log message="Configured destinations -> {{sync-record.destinations.dir}}" />

        <split>
            <simple>{{sync-record.destinations.dir}}</simple>
            <setProperty propertyName="sync-record-destination">
                <simple>body</simple>
            </setProperty>

            <log message="Publishing to destination: ${property.sync-record-destination}" />
            
            <setBody>
                <simple>${property.sync-record}</simple>
            </setBody>
            <marshal>
                <json library="Jackson" />
            </marshal>
            <setBody>
                <simple>{"syncRecord": ${body}, "entity": ${property.entity-payload}}</simple>
            </setBody>
            
            <!--<process ref="pgpEncryptService"/>-->
            <toD uri="{{camel.output.endpoint}}/${property.sync-record-destination}" />
        </split>

        <setBody>
            <simple>${property.sync-record}</simple>
        </setBody>

        <log message="Archiving the sync record" />

        <toD uri="sql:INSERT INTO dbsync_sync_record_archive(entity_id, entity_table_name, operation, date_created, uuid, archive_date) SELECT entity_id, entity_table_name, operation, date_created, uuid, now() FROM dbsync_sync_record WHERE uuid = '${body.uuid}'?dataSource=openmrsDataSource" />

        <log message="Deleting the sync record" />

        <toD uri="sql:DELETE FROM dbsync_sync_record WHERE uuid = '${body.uuid}'?dataSource=openmrsDataSource" />

    </route>

</routes>
