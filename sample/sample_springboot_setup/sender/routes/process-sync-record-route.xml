<routes xmlns="http://camel.apache.org/schema/spring">

    <route id="process-sync-record" errorHandlerRef="deadLetterChannelBuilder">
        <from uri="direct:process-sync-record" />

        <log message=":" />
        <!-- TODO set status of the record to processing, wrap all code in a try catch clause and set result status -->

        <log message="Stage sync attempt for: ${body}" />

        <setProperty propertyName="sync-record">
            <simple>${body}</simple>
        </setProperty>

        <toD uri="jpa:org.openmrs.sync.app.management.entity.SyncAttempt?query=SELECT a FROM org.openmrs.sync.app.management.entity.SyncAttempt a WHERE a.syncRecordUuid = '${body.uuid}' AND (a.status = 'NEW' OR a.status = 'PROCESSING' OR a.status = 'SUCCESS')" />

        <choice>
            <when>
                <simple>${body.size} > 1</simple>
                <!-- TODO log error message instead and mark the sync record status as failed and proceed -->
                <throwException message="Found multiple new attempts for the same DB -> ${body}"
                                exceptionType="org.openmrs.sync.component.exception.OpenmrsSyncException" />
            </when>
            <when>
                <simple>${body.size} == 0</simple>
                <setBody>
                    <spel>
                        #{new org.openmrs.sync.app.management.entity.SyncAttempt()}
                    </spel>
                </setBody>
                <script>
                    <spel>
                        #{body.setSyncRecordUuid(getProperty('sync-record').getUuid())}
                        #{body.setStatus(T(org.openmrs.sync.component.common.Status).valueOf('NEW'))}
                        #{body.setDateCreated(new java.util.Date())}
                        #{body.setUuid(T(java.util.UUID).randomUUID())}
                    </spel>
                </script>

                <log message="Creating ${body}" />

                <to uri="jpa:org.openmrs.sync.app.management.entity.SyncAttempt?usePersist=true" />

                <log message="Sync attempt staged" />
            </when>
            <otherwise>
                <log message="Found an existing ${body}" />

                <setBody>
                    <simple>${body[0]}</simple>
                </setBody>
            </otherwise>
        </choice>

        <setBody>
            <simple>${property.sync-record}</simple>
        </setBody>
        <choice>
            <when>
                <simple>${body.status} == 'NEW'</simple>
                <log message="Updating the sync record status to PROCESSING" />
                <toD uri="sql:UPDATE dbsync_sync_record SET status = 'PROCESSING', start_date = now() WHERE uuid = '${body.uuid}'?dataSource=openmrsDataSource" />
            </when>
        </choice>

        <!-- TODO Log count of DBs we have successfully queued to -->
        <log message="Done staging sync attempts" />

    </route>

</routes>
