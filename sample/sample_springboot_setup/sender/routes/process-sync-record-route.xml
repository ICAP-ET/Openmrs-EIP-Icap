<routes xmlns="http://camel.apache.org/schema/spring">

    <route id="process-sync-record" errorHandlerRef="deadLetterChannelBuilder">
        <from uri="direct:process-sync-record" />

        <log message=":" />
        
        <log message="Processing -> ${body}" />

        <setProperty propertyName="sync-record">
            <simple>${body}</simple>
        </setProperty>
        
        <toD uri="jpa:org.openmrs.sync.app.management.entity.OpenmrsDatabase?query=SELECT d FROM org.openmrs.sync.app.management.entity.OpenmrsDatabase d" />

        <split streaming="true">
            <simple>${body}</simple>
            <setProperty propertyName="openmrs-db">
                <simple>${body}</simple>
            </setProperty>

            <log message="Syncing to: ${body}" />

            <toD uri="jpa:org.openmrs.sync.app.management.entity.SyncAttempt?query=SELECT a FROM org.openmrs.sync.app.management.entity.SyncAttempt a WHERE a.syncRecordUuid = '${property.sync-record.uuid}' AND a.destination = ${property.openmrs-db.id}" />

            <choice>
                <when>
                    <simple>${body.size()} == 0</simple>
                    <setProperty propertyName="sync-attempt">
                        <spel>
                            #{new org.openmrs.sync.app.management.entity.SyncAttempt()}
                        </spel>
                    </setProperty>

                    <script>
                        <spel>
                            #{getProperty('sync-attempt').setSyncRecordUuid(getProperty('sync-record').getUuid())}
                            #{getProperty('sync-attempt').setDestination(getProperty('openmrs-db'))}
                            #{getProperty('sync-attempt').setStatus(T(org.openmrs.sync.component.common.Status).valueOf('NEW'))}
                            #{getProperty('sync-attempt').setDateCreated(new java.util.Date())}
                            #{getProperty('sync-attempt').setUuid(T(java.util.UUID).randomUUID())}
                        </spel>
                    </script>
                    <setBody>
                        <simple>${property.sync-attempt}</simple>
                    </setBody>

                    <log message="Creating ${body}" />

                    <to uri="jpa:org.openmrs.sync.app.management.entity.SyncAttempt?usePersist=true" />

                    <log message="Successfully created ${body}" />

                </when>
                <otherwise>
                    <log message="Found attempt(s): ${body}" />
                </otherwise>
            </choice>

            <log message="Successfully Synced to: ${property.openmrs-db}" />
            
        </split>

        <log message="Successfully processed ${property.sync-record}" />

    </route>

</routes>
